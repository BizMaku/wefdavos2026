<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Davos 2026 | House Events Guide</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      /* === WEF Davos 2026-inspired palette (from the page screenshot) === */
      --bg-950: #030609;      /* near-black */
      --bg-900: #0b1120;      /* deep navy */
      --navy-900: #172134;    /* dark slate/nav */
      --navy-800: #0a3182;    /* primary hero blue */
      --navy-700: #062a7b;    /* deeper blue */
      --blue-600: #0065f2;    /* button blue */
      --blue-500: #4568b2;    /* lighter accent */
      --text: #ffffff;
      --muted: #afc2e6;
      --muted-2: rgba(175, 194, 230, 0.75);
      --border: rgba(255,255,255,0.12);
      --border-soft: rgba(255,255,255,0.08);

      --glass: rgba(11, 17, 32, 0.60);
      --glass-2: rgba(23, 33, 52, 0.55);

      --shadow: 0 20px 60px rgba(0,0,0,0.45);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body{
      font-family: "Inter", sans-serif;
      background: radial-gradient(1200px 700px at 50% 20%, rgba(10,49,130,0.55) 0%, rgba(3,6,9,1) 60%),
                  linear-gradient(180deg, var(--bg-950) 0%, var(--bg-900) 100%);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Animated Background */
    .bg-animation{
      position: fixed; inset: 0; z-index: -1; overflow: hidden;
    }
    .bg-animation::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:
        radial-gradient(ellipse at 35% 20%, rgba(0,101,242,0.28) 0%, transparent 55%),
        radial-gradient(ellipse at 70% 35%, rgba(10,49,130,0.22) 0%, transparent 55%),
        radial-gradient(ellipse at 25% 75%, rgba(69,104,178,0.18) 0%, transparent 50%);
      filter: blur(0px);
      animation: bgMove 20s ease-in-out infinite;
      transform: translate3d(0,0,0);
    }
    @keyframes bgMove{
      0%,100% { transform: translate(0,0) rotate(0deg) scale(1); }
      33%     { transform: translate(2%,1%) rotate(0.8deg) scale(1.02); }
      66%     { transform: translate(-1%,2%) rotate(-0.6deg) scale(1.01); }
    }

    /* Header */
    header{
      position: relative;
      padding: 56px 28px 44px;
      text-align: center;
      border-bottom: 1px solid var(--border-soft);
    }
    .logo-container{ margin-bottom: 22px; }

    .logo{
      font-family: "Inter", sans-serif;
      font-size: clamp(2.1rem, 5vw, 4rem);
      font-weight: 800;
      letter-spacing: -0.02em;
      line-height: 1.06;
      background: linear-gradient(135deg, #ffffff 0%, rgba(255,255,255,0.92) 30%, rgba(175,194,230,0.92) 62%, rgba(0,101,242,0.95) 100%);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      animation: shimmer 3.2s ease-in-out infinite;
    }
    @keyframes shimmer{
      0%,100% { filter: brightness(1); }
      50% { filter: brightness(1.15); }
    }

    .tagline{
      margin-top: 10px;
      font-size: 0.95rem;
      letter-spacing: 0.28em;
      text-transform: uppercase;
      color: var(--muted-2);
    }

    .dates-badge{
      display:inline-block;
      margin-top: 20px;
      padding: 11px 22px;
      border: 1px solid rgba(0,101,242,0.65);
      border-radius: 999px;
      font-size: 0.9rem;
      letter-spacing: 0.12em;
      color: rgba(255,255,255,0.92);
      background: linear-gradient(180deg, rgba(0,101,242,0.14) 0%, rgba(10,49,130,0.08) 100%);
      position: relative;
      overflow:hidden;
    }
    .dates-badge::before{
      content:"";
      position:absolute; top:0; left:-120%;
      width:120%; height:100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.12), transparent);
      animation: slideBadge 3.5s ease-in-out infinite;
    }
    @keyframes slideBadge{
      0% { left:-120%; }
      100% { left:120%; }
    }

    /* Navigation */
    .day-nav{
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(3,6,9,0.85);
      backdrop-filter: blur(18px);
      padding: 16px 0;
      border-bottom: 1px solid var(--border-soft);
    }
    .day-tabs{
      display:flex;
      justify-content:center;
      gap: 10px;
      flex-wrap: wrap;
      padding: 0 16px;
    }
    .day-tab{
      padding: 11px 18px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 999px;
      color: rgba(255,255,255,0.92);
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.25s ease;
      position: relative;
      overflow:hidden;
    }
    .day-tab::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(135deg, rgba(0,101,242,0.95), rgba(10,49,130,0.85));
      opacity:0;
      transition: opacity 0.25s ease;
    }
    .day-tab:hover{
      transform: translateY(-2px);
      border-color: rgba(0,101,242,0.55);
    }
    .day-tab.active{
      border-color: transparent;
    }
    .day-tab.active::before{ opacity:1; }
    .day-tab span{ position: relative; z-index: 1; }
    .day-tab .day-name{
      display:block;
      font-size: 0.7rem;
      opacity: 0.78;
      margin-top: 2px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    /* Stats */
    .stats-bar{
      display:flex;
      justify-content:center;
      gap: 36px;
      padding: 26px 16px;
      border-bottom: 1px solid var(--border-soft);
    }
    .stat{ text-align:center; }
    .stat-value{
      font-family: "Inter", sans-serif;
      font-size: 2.2rem;
      font-weight: 800;
      background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(175,194,230,0.92), rgba(0,101,242,0.95));
      -webkit-background-clip:text;
      background-clip:text;
      color: transparent;
    }
    .stat-label{
      margin-top: 6px;
      font-size: 0.72rem;
      letter-spacing: 0.22em;
      text-transform: uppercase;
      color: var(--muted-2);
    }

    /* Search */
    .search-container{
      max-width: 560px;
      margin: 0 auto 18px;
      padding: 0 16px;
    }
    .search-input{
      width:100%;
      padding: 14px 18px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 999px;
      color: var(--text);
      font-size: 1rem;
      outline: none;
      transition: all 0.2s ease;
    }
    .search-input:focus{
      border-color: rgba(0,101,242,0.7);
      box-shadow: 0 0 0 6px rgba(0,101,242,0.12);
    }
    .search-input::placeholder{ color: rgba(175,194,230,0.55); }

    /* Filter Bar */
    .filter-bar{
      display:flex;
      justify-content:center;
      gap: 10px;
      padding: 10px 16px 26px;
      flex-wrap: wrap;
    }
    .filter-btn{
      padding: 8px 14px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 999px;
      color: rgba(255,255,255,0.86);
      font-size: 0.82rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .filter-btn:hover, .filter-btn.active{
      background: rgba(0,101,242,0.20);
      border-color: rgba(0,101,242,0.55);
      color: #fff;
    }

    /* Main Content */
    main{
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px 18px 56px;
    }
    .day-section{ display:none; }
    .day-section.active{
      display:block;
      animation: fadeIn 0.35s ease-out;
    }
    @keyframes fadeIn{
      from{ opacity:0; transform: translateY(14px); }
      to{ opacity:1; transform: translateY(0); }
    }

    .day-header{
      text-align:center;
      margin-bottom: 32px;
    }
    .day-title{
      font-family: "Playfair Display", serif;
      font-size: 2.6rem;
      font-weight: 700;
      margin-bottom: 8px;
      letter-spacing: -0.02em;
    }
    .event-count{
      font-size: 0.86rem;
      color: rgba(175,194,230,0.70);
      letter-spacing: 0.22em;
      text-transform: uppercase;
    }

    /* Grid */
    .events-grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
      gap: 18px;
    }
    @media (max-width: 480px){
      .events-grid{ grid-template-columns: 1fr; }
      .stats-bar{ gap: 18px; }
    }

    /* Event Card */
    .event-card{
      background: linear-gradient(145deg, rgba(23,33,52,0.62), rgba(11,17,32,0.72));
      border: 1px solid var(--border-soft);
      border-radius: 22px;
      padding: 22px;
      cursor: pointer;
      transition: all 0.25s ease;
      position: relative;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.20);
    }
    .event-card::before{
      content:"";
      position:absolute; top:0; left:0;
      width:100%; height: 3px;
      background: linear-gradient(90deg, rgba(0,101,242,0.95), rgba(10,49,130,0.95), rgba(69,104,178,0.95));
      transform: scaleX(0);
      transform-origin:left;
      transition: transform 0.25s ease;
    }
    .event-card:hover{
      transform: translateY(-6px);
      border-color: rgba(255,255,255,0.16);
      box-shadow: var(--shadow);
    }
    .event-card:hover::before{ transform: scaleX(1); }

    .event-time{
      display:flex;
      align-items:center;
      gap: 10px;
      margin-bottom: 12px;
    }
    .time-badge{
      padding: 6px 12px;
      background: rgba(0,101,242,0.16);
      border: 1px solid rgba(0,101,242,0.35);
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 700;
      color: rgba(255,255,255,0.92);
      letter-spacing: 0.03em;
    }

    .event-name{
      font-family: "Playfair Display", serif;
      font-size: 1.28rem;
      font-weight: 700;
      line-height: 1.35;
      margin-bottom: 10px;
      transition: color 0.2s ease;
    }
    .event-card:hover .event-name{ color: rgba(175,194,230,0.98); }

    .event-organizer{
      font-size: 0.86rem;
      color: rgba(175,194,230,0.92);
      margin-bottom: 10px;
      font-weight: 600;
    }
    .event-address{
      font-size: 0.86rem;
      color: rgba(175,194,230,0.70);
      line-height: 1.45;
    }

    .event-meta{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 16px;
      padding-top: 14px;
      border-top: 1px solid rgba(255,255,255,0.08);
    }
    .meta-tag{
      padding: 6px 10px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 999px;
      font-size: 0.74rem;
      color: rgba(255,255,255,0.86);
    }
    .meta-tag.vibe{
      background: linear-gradient(135deg, rgba(0,101,242,0.22), rgba(10,49,130,0.16));
      border-color: rgba(0,101,242,0.18);
      color: #fff;
    }
    .meta-tag.rsvp{
      background: rgba(69,104,178,0.18);
      border-color: rgba(69,104,178,0.28);
      color: #fff;
    }

    .event-link{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      margin-top: 16px;
      padding: 10px 16px;
      background: linear-gradient(135deg, rgba(0,101,242,0.95), rgba(10,49,130,0.85));
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 999px;
      color:#fff;
      text-decoration:none;
      font-size: 0.85rem;
      font-weight: 700;
      cursor:pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .event-link:hover{
      transform: translateY(-1px);
      box-shadow: 0 12px 28px rgba(0,101,242,0.22);
    }

    /* Modal */
    .modal-overlay{
      display:none;
      position:fixed; inset:0;
      background: rgba(0,0,0,0.78);
      backdrop-filter: blur(10px);
      z-index: 1000;
      align-items:center;
      justify-content:center;
      padding: 18px;
    }
    .modal-overlay.active{
      display:flex;
      animation: modalFadeIn 0.2s ease-out;
    }
    @keyframes modalFadeIn{ from{opacity:0;} to{opacity:1;} }

    .modal-content{
      background: linear-gradient(145deg, rgba(23,33,52,0.92), rgba(11,17,32,0.92));
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 24px;
      max-width: 680px;
      width: 100%;
      max-height: 90vh;
      overflow-y:auto;
      padding: 28px;
      position: relative;
      box-shadow: var(--shadow);
      animation: modalSlideIn 0.25s ease-out;
    }
    @keyframes modalSlideIn{
      from{ transform: translateY(18px); opacity:0; }
      to{ transform: translateY(0); opacity:1; }
    }
    .modal-close{
      position:absolute; top: 14px; right: 14px;
      width: 40px; height: 40px;
      border-radius: 50%;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color:#fff;
      font-size: 1.5rem;
      cursor:pointer;
      transition: all 0.2s ease;
    }
    .modal-close:hover{
      background: rgba(0,101,242,0.22);
      border-color: rgba(0,101,242,0.45);
      transform: rotate(90deg);
    }
    .modal-title{
      font-family:"Playfair Display", serif;
      font-size: 1.9rem;
      font-weight: 700;
      margin-bottom: 8px;
      padding-right: 48px;
    }
    .modal-organizer{
      color: rgba(175,194,230,0.92);
      font-size: 1rem;
      margin-bottom: 18px;
      font-weight: 600;
    }
    .modal-details{ display:grid; gap: 14px; }
    .detail-row{ display:flex; gap: 12px; align-items:flex-start; }
    .detail-icon{
      width: 40px; height: 40px;
      border-radius: 12px;
      background: rgba(0,101,242,0.14);
      border: 1px solid rgba(0,101,242,0.22);
      display:flex; align-items:center; justify-content:center;
      flex-shrink:0;
      font-size: 1.1rem;
    }
    .detail-content h4{
      font-size: 0.72rem;
      color: rgba(175,194,230,0.70);
      letter-spacing: 0.18em;
      text-transform: uppercase;
      margin-bottom: 4px;
    }
    .detail-content p{
      font-size: 0.98rem;
      line-height: 1.5;
      color: rgba(255,255,255,0.92);
      white-space: pre-wrap;
    }

    /* Footer */
    footer{
      text-align:center;
      padding: 56px 16px;
      border-top: 1px solid var(--border-soft);
      margin-top: 40px;
    }
    .footer-logo{
      font-family: "Inter", sans-serif;
      font-weight: 800;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      opacity: 0.7;
      margin-bottom: 10px;
    }
    .footer-text{
      font-size: 0.82rem;
      color: rgba(175,194,230,0.68);
      letter-spacing: 0.14em;
      text-transform: uppercase;
    }

    /* Empty State */
    .no-results{
      text-align:center;
      padding: 64px 16px;
      color: rgba(175,194,230,0.70);
    }
    .no-results h3{
      font-family: "Playfair Display", serif;
      font-size: 1.6rem;
      margin-bottom: 10px;
      color: #fff;
    }

    /* Scrollbar */
    ::-webkit-scrollbar{ width: 8px; }
    ::-webkit-scrollbar-track{ background: rgba(3,6,9,0.7); }
    ::-webkit-scrollbar-thumb{ background: rgba(0,101,242,0.55); border-radius: 6px; }

    /* Gate */
    #gate-wrapper{
      position: relative;
      min-height: 100vh;
      padding: 34px 16px 56px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
    }
    #gate-wrapper header{ border-bottom:none; padding: 42px 16px 20px; }
    .gate-main{ max-width: 520px; width: 100%; margin: 0 auto; }
    .gate-card{
      background: rgba(11,17,32,0.72);
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,0.14);
      padding: 22px 18px 24px;
      box-shadow: var(--shadow);
    }
    .gate-card h2{
      font-family:"Playfair Display", serif;
      font-size: 1.5rem;
      margin-bottom: 6px;
    }
    .gate-card p{
      font-size: 0.92rem;
      color: rgba(175,194,230,0.84);
      margin-bottom: 14px;
      line-height: 1.5;
    }
    .gate-label{
      font-size: 0.86rem;
      display:block;
      margin-bottom: 6px;
      color: rgba(255,255,255,0.88);
      font-weight: 600;
    }
    .gate-input{
      width:100%;
      margin-bottom: 12px;
      padding: 11px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.03);
      color: #fff;
      font-size: 0.95rem;
      outline:none;
      transition: all 0.2s ease;
    }
    .gate-input:focus{
      border-color: rgba(0,101,242,0.65);
      box-shadow: 0 0 0 6px rgba(0,101,242,0.12);
    }
    .gate-roles{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      font-size: 0.88rem;
      margin-bottom: 14px;
      color: rgba(255,255,255,0.88);
    }
    .gate-roles label{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.10);
    }
    .gate-submit{
      width:100%;
      padding: 12px 0;
      border:none;
      border-radius: 999px;
      background: linear-gradient(135deg, rgba(0,101,242,0.98), rgba(10,49,130,0.88));
      color:#fff;
      font-weight: 800;
      font-size: 0.98rem;
      cursor:pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .gate-submit:hover{
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(0,101,242,0.22);
    }
    #formMessage{ margin-top: 10px; font-size: 0.85rem; }
  </style>
</head>

<body>
  <div class="bg-animation"></div>

  <!-- GATE FORM WRAPPER -->
  <div id="gate-wrapper">
    <header>
      <div class="logo-container">
        <h1 class="logo">Davos House Guide</h1>
        <p class="tagline">WEF Week 2026</p>
      </div>
      <div class="dates-badge">January 17 ‚Äì 23, 2026 ‚Ä¢ Davos, Switzerland</div>
    </header>

    <main class="gate-main">
      <form id="leadForm" class="gate-card">
        <h2>Unlock the curated Davos guide</h2>
        <p>Enter your details to access the Davos Houses, lounges, and key events list.</p>

        <label class="gate-label" for="name">Full name</label>
        <input type="text" id="name" class="gate-input" required>

        <label class="gate-label" for="phone">Phone number</label>
        <input type="tel" id="phone" class="gate-input" required>

        <label class="gate-label" for="email">Email</label>
        <input type="email" id="email" class="gate-input" required>

        <p class="gate-label" style="margin-top:8px;">I am a:</p>
        <div class="gate-roles">
          <label><input type="checkbox" name="role" value="Investor"> Investor</label>
          <label><input type="checkbox" name="role" value="Founder"> Founder</label>
          <label><input type="checkbox" name="role" value="Media"> Media</label>
          <label><input type="checkbox" name="role" value="Operator"> Operator</label>
        </div>

        <button type="submit" class="gate-submit">View Davos Guide</button>
        <p id="formMessage"></p>
      </form>
    </main>
  </div>

  <!-- ACTUAL SITE CONTENT (INITIALLY HIDDEN) -->
  <div id="site-content" style="display:none;">
    <header>
      <div class="logo-container">
        <h1 class="logo">Davos House Guide</h1>
        <p class="tagline">WEF Week 2026</p>
      </div>
      <div class="dates-badge">January 17 ‚Äì 23, 2026 ‚Ä¢ Davos, Switzerland</div>
    </header>

    <nav class="day-nav">
      <div class="day-tabs" id="dayTabs"></div>
    </nav>

    <div class="stats-bar">
      <div class="stat">
        <div class="stat-value" id="totalEvents">0</div>
        <div class="stat-label">Total Entries</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="totalDays">0</div>
        <div class="stat-label">Tabs</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="currentDayEvents">0</div>
        <div class="stat-label">Shown</div>
      </div>
    </div>

    <div class="search-container">
      <input type="text" class="search-input" id="searchInput" placeholder="Search houses, lounges, locations, notes...">
    </div>

    <div class="filter-bar">
      <button class="filter-btn active" data-filter="all">All</button>
      <button class="filter-btn" data-filter="allweek">All Week</button>
      <button class="filter-btn" data-filter="places">Places</button>
      <button class="filter-btn" data-filter="rsvp">RSVP</button>
      <button class="filter-btn" data-filter="on">ON Promenade</button>
      <button class="filter-btn" data-filter="off">OFF Promenade</button>
    </div>

    <main id="mainContent"></main>

    <!-- Modal -->
    <div class="modal-overlay" id="modal">
      <div class="modal-content">
        <button class="modal-close" onclick="closeModal()">√ó</button>
        <h2 class="modal-title" id="modalTitle"></h2>
        <p class="modal-organizer" id="modalOrganizer"></p>
        <div class="modal-details" id="modalDetails"></div>
      </div>
    </div>

    <footer>
      <div class="footer-logo">DAVOS ‚Ä¢ 2026</div>
      <p class="footer-text">Houses ‚Ä¢ Lounges ‚Ä¢ Key Locations</p>
    </footer>
  </div>

  <script>
    // === GOOGLE SHEETS WEB APP (EVENTS SOURCE) ===
    // This MUST be your deployed Apps Script "web app" that returns the sheet rows as JSON.
    const EVENTS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbzgiJETsUIFtpZkrCzh_gUVFXklskFyNNeXqnTSbSHaXG14uEAa1DEBgDhGS7xClXim/exec';

    // === GOOGLE SHEETS FORM ENDPOINT (LEAD CAPTURE) ===
    // Keep this as your lead form endpoint.
    const FORM_ENDPOINT = 'https://script.google.com/macros/s/AKfycbxiVttnF2evrhwNsdRRgL506mAaYynEDNWEMd-5lWY4k5B_jzKiWr7AmbBOB-XY8JiM/exec';

    // === LOCAL GATE MEMORY (SKIP FORM NEXT TIME ON SAME DEVICE) ===
    const GATE_STORAGE_KEY = "davos_gate:v1";

    // === EVENTS STATE (LOADED LIVE) ===
    let eventsData = {}; // populated from sheet
    const isISODateKey = (k) => /^\d{4}-\d{2}-\d{2}$/.test(k);

    let orderedKeys = [];
    let currentDay = "ALL_WEEK";
    let currentFilter = "all";
    let searchTerm = "";

    document.addEventListener("DOMContentLoaded", async () => {
      setupGateForm();

      // If already unlocked on this device, skip the gate immediately
      if (getGateSaved()) {
        unlockGuideUI();
      }

      // Load events from the deployed web app
      await loadEventsFromSheet();

      // Render UI after data exists
      buildOrderedKeys();
      renderDayTabs();
      renderEvents();
      setupEventListeners();
      updateStats();
    });

    // --- Gate Memory ---
    function getGateSaved() {
      try {
        const raw = localStorage.getItem(GATE_STORAGE_KEY);
        if (!raw) return null;
        const obj = JSON.parse(raw);
        if (!obj || typeof obj !== "object") return null;
        return obj;
      } catch {
        return null;
      }
    }
    function saveGate(data) {
      localStorage.setItem(GATE_STORAGE_KEY, JSON.stringify({ ...data, savedAt: new Date().toISOString() }));
    }
    function unlockGuideUI() {
      const gateWrapper = document.getElementById("gate-wrapper");
      const siteContent = document.getElementById("site-content");
      if (gateWrapper) gateWrapper.style.display = "none";
      if (siteContent) siteContent.style.display = "block";
      window.scrollTo(0, 0);
    }

    // --- Gate Form ---
    function setupGateForm() {
      const gateForm = document.getElementById("leadForm");
      const formMessage = document.getElementById("formMessage");
      if (!gateForm) return;

      gateForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        formMessage.textContent = "Submitting...";
        formMessage.style.color = "rgba(175,194,230,0.85)";

        const name = document.getElementById("name").value.trim();
        const phone = document.getElementById("phone").value.trim();
        const email = document.getElementById("email").value.trim();
        const roles = Array.from(document.querySelectorAll('input[name="role"]:checked')).map(cb => cb.value).join(",");

        if (!roles) {
          formMessage.textContent = "Please select at least one role.";
          formMessage.style.color = "#ffb4b4";
          return;
        }

        // Save locally so the intake won't show again on this device
        saveGate({ name, phone, email, role: roles });

        try {
          await fetch(FORM_ENDPOINT, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, phone, email, role: roles })
          });

          formMessage.textContent = "Thanks! Loading guide...";
          formMessage.style.color = "#bfe2ff";

          setTimeout(() => {
            unlockGuideUI();
          }, 500);
        } catch (err) {
          console.error(err);
          // Even if submission fails, the user is still unlocked on this device (because we saved locally)
          formMessage.textContent = "Thanks! Loading guide...";
          formMessage.style.color = "#bfe2ff";
          setTimeout(() => unlockGuideUI(), 300);
        }
      });
    }

    // --- Load Events from Sheet Web App ---
    async function loadEventsFromSheet() {
      // Initialize with empty containers so UI doesn't break
      eventsData = {
        "ALL_WEEK": { day_name: "All Week", month_day: "Jan 17‚Äì23", events: [] },
        "PLACES":   { day_name: "Places",  month_day: "Jan 17‚Äì23", events: [] }
      };

      try {
        const res = await fetch(EVENTS_ENDPOINT, { method: "GET", cache: "no-store" });
        const json = await res.json();

        const rows = normalizeRows(json);

        // Build eventsData from rows
        for (const row of rows) {
          const name = getVal(row, ["House/Event Name", "House / Event Name", "House Event Name", "Event", "Event Name"]);
          const organizer = getVal(row, ["ON/OFF Promenade ?", "ON/OFF Promenade", "ON OFF Promenade", "Promenade", "ON/OFF"]);
          const dateCell = getVal(row, ["Date", "DATE"]);
          const website = getVal(row, ["Event Website", "Website", "Event Website "]);
          const rsvp = getVal(row, ["RSVP Link", "RSVP", "RSVP link"]);
          const location = getVal(row, ["Location", "LOCATION"]);
          const notes = getVal(row, ["Notes", "NOTE", "Notes "]);

          const evName = String(name || "").trim();
          const lowerName = evName.toLowerCase();

          // Skip header/label/blank rows (this removes the bogus "List of Events" card)
          if (!evName) continue;
          if (lowerName === "list of events") continue;
          if (lowerName === "house/event name" || lowerName === "house / event name" || lowerName === "event name") continue;

          const { dayKey, start } = parseSheetDateCell(dateCell);

          // Decide: ALL_WEEK vs PLACES vs ISO date
          // PLACES heuristic: All Week row AND no links (or looks like a location POI)
          const hasAnyLink = isHttp(rsvp) || isHttp(website);
          const looksLikePlace = /congress hall|ice village|kurpark|registration|media village|the dome|jakobshorn|openai house|google house|goals house|human change house/i.test(lowerName);

          let bucketKey = dayKey || "ALL_WEEK";
          if (bucketKey === "ALL_WEEK" && (!hasAnyLink || looksLikePlace)) {
            // Keep "places" separate if it appears to be a POI / location row
            // (and still allow all-week items with links to remain in All Week)
            if (looksLikePlace || (!hasAnyLink && !String(notes||"").trim())) bucketKey = "PLACES";
          }

          if (!eventsData[bucketKey]) {
            // Create day bucket if ISO date
            if (isISODateKey(bucketKey)) {
              const d = new Date(`${bucketKey}T00:00:00`);
              const dayName = d.toLocaleDateString("en-US", { weekday: "long" });
              const monthDay = d.toLocaleDateString("en-US", { month: "long", day: "numeric" });
              eventsData[bucketKey] = { day_name: dayName, month_day: monthDay, events: [] };
            } else {
              // Fallback
              eventsData[bucketKey] = { day_name: bucketKey, month_day: "Jan 17‚Äì23", events: [] };
            }
          }

          const chosenLink = isHttp(rsvp) ? rsvp : (isHttp(website) ? website : "");

          const ev = {
            event: evName,
            organizer: String(organizer || "").trim(),
            address: String(location || "").trim(),
            start: start || "TBA",
            end: "",
            door: isHttp(rsvp) ? "RSVP" : "Info",
            vibe: bucketKey === "PLACES" ? "Place" : "House",
            link: chosenLink,
            food: false,
            bar: false,
            note: String(notes || "").trim()
          };

          // Extra garbage-row guard: if it has basically nothing besides a name, drop it
          const hasAnyOtherData = Boolean(
            ev.address || ev.organizer || ev.note || ev.link || (ev.start && ev.start !== "TBA")
          );
          if (!hasAnyOtherData) continue;

          eventsData[bucketKey].events.push(ev);
        }

      } catch (err) {
        console.error("Failed to load events from sheet:", err);
        // Keep empty state; UI will show "No results"
      }
    }

    function normalizeRows(json) {
      // Accept a few common shapes:
      // - Array of objects: [{...}, {...}]
      // - { data: [...] } or { rows: [...] } or { items: [...] }
      // - { data: { rows: [...] } }
      if (Array.isArray(json)) return json;
      if (json && Array.isArray(json.data)) return json.data;
      if (json && Array.isArray(json.rows)) return json.rows;
      if (json && Array.isArray(json.items)) return json.items;
      if (json && json.data && Array.isArray(json.data.rows)) return json.data.rows;
      return [];
    }

    function getVal(row, keys) {
      for (const k of keys) {
        if (row && Object.prototype.hasOwnProperty.call(row, k)) return row[k];
      }
      // Try case-insensitive match
      const lowerMap = {};
      if (row && typeof row === "object") {
        for (const [k, v] of Object.entries(row)) lowerMap[String(k).toLowerCase()] = v;
      }
      for (const k of keys) {
        const v = lowerMap[String(k).toLowerCase()];
        if (v !== undefined) return v;
      }
      return "";
    }

    function isHttp(val) {
      return typeof val === "string" && val.trim().toLowerCase().startsWith("http");
    }

    function parseSheetDateCell(raw) {
      const s = String(raw || "").trim();
      if (!s) return { dayKey: "ALL_WEEK", start: "TBA" };

      // All Week rows
      if (/all\s*week/i.test(s)) return { dayKey: "ALL_WEEK", start: "TBA" };

      // Strip any trailing " - ..." parts
      const cleaned = s.split(" - ")[0].trim();

      // Match: M/D/YYYY H:MM (24h)
      const m = cleaned.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})\s+(\d{1,2}):(\d{2})/);
      if (!m) return { dayKey: "ALL_WEEK", start: "TBA" };

      const mm = String(m[1]).padStart(2, "0");
      const dd = String(m[2]).padStart(2, "0");
      const yyyy = m[3];
      const hh = String(m[4]).padStart(2, "0");
      const min = m[5];

      return {
        dayKey: `${yyyy}-${mm}-${dd}`,
        start: `${hh}:${min}:00`
      };
    }

    function buildOrderedKeys() {
      // Order: All Week, Places, then chronological ISO dates
      orderedKeys = [
        "ALL_WEEK",
        "PLACES",
        ...Object.keys(eventsData).filter(isISODateKey).sort()
      ].filter(k => eventsData[k] && Array.isArray(eventsData[k].events));

      // Ensure we land on a real tab
      if (!eventsData[currentDay]) currentDay = orderedKeys[0] || "ALL_WEEK";
      if (!eventsData[currentDay]) {
        // As absolute fallback
        eventsData["ALL_WEEK"] = eventsData["ALL_WEEK"] || { day_name: "All Week", month_day: "Jan 17‚Äì23", events: [] };
        orderedKeys = ["ALL_WEEK"];
        currentDay = "ALL_WEEK";
      }
    }

    // --- Tabs ---
    function renderDayTabs() {
      const tabsContainer = document.getElementById("dayTabs");
      tabsContainer.innerHTML = "";

      orderedKeys.forEach((key) => {
        const dayData = eventsData[key];
        const tab = document.createElement("button");
        tab.className = `day-tab ${key === currentDay ? "active" : ""}`;
        tab.dataset.date = key;

        if (isISODateKey(key)) {
          const dayNum = (dayData.month_day || "").split(" ")[1] || key.split("-")[2];
          tab.innerHTML = `
            <span>
              ${dayNum}
              <span class="day-name">${(dayData.day_name || "").slice(0,3)}</span>
            </span>
          `;
        } else {
          tab.innerHTML = `
            <span>
              ${dayData.day_name}
              <span class="day-name">${dayData.month_day}</span>
            </span>
          `;
        }

        tab.addEventListener("click", () => selectDay(key));
        tabsContainer.appendChild(tab);
      });

      document.getElementById("totalDays").textContent = orderedKeys.length;
    }

    function selectDay(key) {
      currentDay = key;
      document.querySelectorAll(".day-tab").forEach(tab => {
        tab.classList.toggle("active", tab.dataset.date === key);
      });
      renderEvents();
      updateStats();
    }

    // --- Rendering ---
    function renderEvents() {
      const main = document.getElementById("mainContent");
      const dayData = eventsData[currentDay] || { day_name: "", month_day: "", events: [] };

      let filteredEvents = (dayData.events || []).filter(ev => {
        const hay = [
          ev.event, ev.organizer, ev.address, ev.note, ev.vibe, ev.door
        ].filter(Boolean).join(" ").toLowerCase();

        const matchesSearch = !searchTerm || hay.includes(searchTerm.toLowerCase());

        let matchesFilter = true;
        if (currentFilter === "all") matchesFilter = true;
        else if (currentFilter === "allweek") matchesFilter = (currentDay === "ALL_WEEK");
        else if (currentFilter === "places") matchesFilter = (currentDay === "PLACES");
        else if (currentFilter === "rsvp") matchesFilter = (ev.door || "").toLowerCase().includes("rsvp") || (ev.link || "").startsWith("http");
        else if (currentFilter === "on") matchesFilter = (ev.organizer || "").toLowerCase().includes("on");
        else if (currentFilter === "off") matchesFilter = (ev.organizer || "").toLowerCase().includes("off");

        return matchesSearch && matchesFilter;
      });

      main.innerHTML = `
        <section class="day-section active">
          <div class="day-header">
            <h2 class="day-title">${dayData.day_name}${isISODateKey(currentDay) ? `, ${dayData.month_day}` : ""}</h2>
            <p class="event-count">${filteredEvents.length} entries</p>
          </div>

          ${filteredEvents.length ? `
            <div class="events-grid">
              ${filteredEvents.map(ev => createEventCard(ev)).join("")}
            </div>
          ` : `
            <div class="no-results">
              <h3>No results</h3>
              <p>Try a different search term or filter.</p>
            </div>
          `}
        </section>
      `;

      document.getElementById("currentDayEvents").textContent = filteredEvents.length;
    }

    function createEventCard(ev) {
      const timeDisplay = formatTime(ev.start);
      const endDisplay = ev.end ? ` - ${formatTime(ev.end)}` : "";
      const safeJson = JSON.stringify(ev).replace(/"/g, "&quot;");

      const tags = [];
      if (ev.vibe) tags.push(`<span class="meta-tag vibe">${escapeHtml(ev.vibe)}</span>`);
      if (ev.door) tags.push(`<span class="meta-tag rsvp">${escapeHtml(ev.door)}</span>`);
      if (ev.organizer) tags.push(`<span class="meta-tag">${escapeHtml(ev.organizer)}</span>`);

      const shortAddr = truncate(ev.address || "", 90);

      return `
        <article class="event-card" onclick="openModal(${safeJson})">
          <div class="event-time">
            <span class="time-badge">${timeDisplay}${endDisplay}</span>
          </div>
          <h3 class="event-name">${escapeHtml(ev.event || "Untitled")}</h3>
          ${ev.organizer ? `<p class="event-organizer">${escapeHtml(ev.organizer)}</p>` : ""}
          ${ev.address ? `<p class="event-address">${escapeHtml(shortAddr)}</p>` : ""}
          <div class="event-meta">${tags.join("")}</div>
          <button class="event-link" onclick="event.stopPropagation(); openModal(${safeJson})">
            View Details ‚Üí
          </button>
        </article>
      `;
    }

    function formatTime(time) {
      if (!time || time === "TBA") return "TBA";
      const parts = String(time).split(":");
      if (parts.length >= 2) {
        let hours = parseInt(parts[0], 10);
        const minutes = parts[1];
        const ampm = hours >= 12 ? "PM" : "AM";
        hours = hours % 12 || 12;
        return `${hours}:${minutes} ${ampm}`;
      }
      return time;
    }

    function truncate(text, length) {
      if (!text) return "";
      return text.length > length ? text.slice(0, length) + "..." : text;
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function updateStats() {
      const total = Object.values(eventsData).reduce((sum, day) => sum + (day.events ? day.events.length : 0), 0);
      document.getElementById("totalEvents").textContent = total;
    }

    // --- Listeners ---
    function setupEventListeners() {
      document.getElementById("searchInput").addEventListener("input", (e) => {
        searchTerm = e.target.value;
        renderEvents();
      });

      document.querySelectorAll(".filter-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          currentFilter = btn.dataset.filter;
          renderEvents();
        });
      });

      document.getElementById("modal").addEventListener("click", (e) => {
        if (e.target.id === "modal") closeModal();
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeModal();
      });
    }

    // --- Modal ---
    function openModal(ev) {
      const modal = document.getElementById("modal");
      document.getElementById("modalTitle").textContent = ev.event || "Untitled";
      document.getElementById("modalOrganizer").textContent = ev.organizer || "";

      const linkBlock = (ev.link && String(ev.link).startsWith("http"))
        ? `<a href="${ev.link}" target="_blank" class="event-link" style="margin-top: 14px; display:inline-flex;">Open Link / RSVP ‚Üí</a>`
        : "";

      document.getElementById("modalDetails").innerHTML = `
        <div class="detail-row">
          <div class="detail-icon">üïê</div>
          <div class="detail-content">
            <h4>Time</h4>
            <p>${formatTime(ev.start)}${ev.end ? " - " + formatTime(ev.end) : ""}</p>
          </div>
        </div>
        <div class="detail-row">
          <div class="detail-icon">üìç</div>
          <div class="detail-content">
            <h4>Location</h4>
            <p>${ev.address || "TBA"}</p>
          </div>
        </div>
        <div class="detail-row">
          <div class="detail-icon">üéüÔ∏è</div>
          <div class="detail-content">
            <h4>Access</h4>
            <p>${ev.door || "Info"}</p>
          </div>
        </div>
        ${ev.note ? `
          <div class="detail-row">
            <div class="detail-icon">üìù</div>
            <div class="detail-content">
              <h4>Notes</h4>
              <p>${escapeHtml(ev.note)}</p>
            </div>
          </div>
        ` : ""}
        ${linkBlock}
      `;

      modal.classList.add("active");
      document.body.style.overflow = "hidden";
    }

    function closeModal() {
      document.getElementById("modal").classList.remove("active");
      document.body.style.overflow = "";
    }
  </script>
</body>
</html>
